{% extends "base.html" %}

{% block content %}
<h2>Problema: {{ problema|replace("_", " ")|replace(".zip", "")|replace("gabarito", "")|upper }}</h2>
<p>Fase {{ fase|upper }} ‚Äì Ano {{ ano }} ‚Äì N√≠vel {{ nivel|replace('p', '') }}</p>

<hr>

<h3>Enunciado</h3>
<iframe 
    src="{{ pdf_url }}" 
    width="100%" 
    height="600px" 
    style="border: 1px solid #ccc; border-radius: 8px;">
</iframe>

<hr>

<div style="margin-top: 12px;">
  <label for="language">Linguagem:</label>
  <select id="language" required>
    <option value="py" selected>Python 3 (.py)</option>
    <option value="c">C (.c)</option>
    <option value="cpp">C++ (.cpp)</option>
    <option value="java">Java (.java)</option>
    <option value="pas">Pascal (.pas)</option>
    <option value="js">Javascript (.js)</option>
  </select>
</div>


<h3>Envie seu c√≥digo</h3>
<textarea id="codigo" name="codigo" style="width:100%; height:200px; font-family: monospace;"></textarea>

<div style="margin-top: 15px;">
    <label>Limite de tempo (segundos):</label>
    <input type="number" id="limiteTempo" min="1" max="10" value="1" required>
    <br>
    <label>Limite de mem√≥ria (MB):</label>
    <input type="number" id="limiteMemoria" min="16" max="1024" value="256" required>
</div>

<div style="margin-top: 15px;">
    <button onclick="enviarCodigo()" class="btn btn-success">Enviar</button>
</div>

<div id="results" style="margin-top: 20px;"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip-utils/0.1.0/jszip-utils.min.js"></script>

<script>
const JUDGE0_URL = "https://judge.darlon.com.br";

async function enviarCodigo() {
    const codigo = document.getElementById('codigo').value.trim();
    const limiteTempo = Number(document.getElementById('limiteTempo').value);
    const limiteMemoria = Number(document.getElementById('limiteMemoria').value);
    const linguagem = document.getElementById('language').value;

    // Vari√°veis injetadas via Jinja (Flask)
    const ano = "{{ ano }}";
    const nivel = "{{ nivel }}";
    const problema = "{{ problema }}";

    if (!linguagem) return alert("Por favor, insira uma linguagem antes de enviar!");
    if (!codigo) return alert("Por favor, insira o c√≥digo antes de enviar!");
    if (
        isNaN(limiteTempo) || isNaN(limiteMemoria) ||
        limiteTempo < 1 || limiteTempo > 10 ||
        limiteMemoria < 16 || limiteMemoria > 1024
    ) {
        return alert("Os limites devem estar entre 1‚Äì10 segundos e 16‚Äì1024 MB!");
    }

    const languageIds = {
        py: 70,   // Python 2.7.17
        c: 47,    // Basic (FBC 1.07.1)
        cpp: 76,  // C++ (Clang 7.0.1)
        java: 62, // Java (OpenJDK 13.0.1)
        pas: 67,  // Pascal (FPC 3.0.4)
        js: 63    // JavaScript (Node.js 12.14.0)
    };

    const toBase64 = str => btoa(unescape(encodeURIComponent(str)));
    const fromBase64 = str => decodeURIComponent(escape(atob(str)));

    const resultsDiv = document.getElementById("results");
    resultsDiv.innerHTML = "<h3>Baixando e testando...</h3>";

    // Caminho para o arquivo ZIP com os casos de teste
    const zipUrl = `/static/problems/${ano}/${nivel.toUpperCase()}/${problema}`;

    try {
        // ‚úÖ Usando JSZipUtils para obter o ZIP em bin√°rio
        const data = await new Promise((resolve, reject) => {
            JSZipUtils.getBinaryContent(zipUrl, (err, data) => {
                if (err) reject(err);
                else resolve(data);
            });
        });

        const zip = await JSZip.loadAsync(data);
        const files = Object.keys(zip.files);
        const inFiles = files.filter(f => f.match(/in/i)).sort();
        const outFiles = files.filter(f => f.match(/(sol|out)/i)).sort();        

        let passed = 0;
        const total = inFiles.length;

        resultsDiv.innerHTML = `<h3>Executando ${total} casos de teste...</h3>`;

        // üîÅ Loop pelos casos de teste
        for (let i = 0; i < total; i++) {
            const input = await zip.file(inFiles[i]).async("string");
            const expected = (await zip.file(outFiles[i]).async("string")).trim();

            const payload = {
                source_code: toBase64(codigo),
                stdin: toBase64(input),
                language_id: languageIds[linguagem],
                base64_encoded: true,
                wait: true
            };

            // Envio ao Judge0
            const res = await fetch(`${JUDGE0_URL}/submissions?base64_encoded=true&wait=true`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });

            const result = await res.json();
            const output = fromBase64(result.stdout || "").trim();
            let status = "Erro";



            if (output === expected) passed++;
            if (output === expected) status = "Accepted";


            // Mostra o progresso caso a caso
            const caseDiv = document.createElement("div");
            caseDiv.innerHTML = `
                <b>Teste ${i + 1}:</b><br>
                <i>Status:</i> ${status}<br>
                <i>Esperado:</i> <pre>${expected}</pre>
                <i>Obtido:</i> <pre>${output}</pre>
                <hr>
            `;
            resultsDiv.appendChild(caseDiv);
        }

        // Resultado final
        const h3 = resultsDiv.querySelector("h3");
        if (h3) h3.remove();

        resultsDiv.insertAdjacentHTML(
            "afterbegin",
            `<h2>Resultado final: ${passed}/${total} casos corretos</h2>`
        );

    } catch (error) {
        console.error(error);
        resultsDiv.textContent = "Erro ao executar testes (ver console).";
        console.log(zipUrl);
    }
}
</script>
{% endblock %}